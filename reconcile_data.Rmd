---
title: "Reconciling Data"
output: html_notebook
---

Once we have our data aggregated, we need to determine the single species choice for each subject_id and determine which events need further investigation to reconcile the species id.

Begin by setting up the workspace
```{r}
rm(list = ls())
library(dplyr)
library(magrittr)
library(stringr)
library(tidyr)
library(ggplot2)
```
### Step 1. Pull in some data and examine it. 
Use the data that were output from aggregate_classifications.Rmd.
```{r}
DF<-read.csv("Data/aggregated_data.csv", stringsAsFactors = F)
```
Now pull in some metadata
```{r}
Metadata <- read.csv("Data/Game_Cam_Metadata.csv", stringsAsFactors = F)
```
### Step 2. Join the two datasets.
Now join the metadata to the aggregated data. Join by round, camera number, sd card number.

```{r}
#first need to get compatible data types
DF$SD_card_num<-as.character((DF$SD_card_num))
DF<-left_join(DF, Metadata, by = c("round" = "Round.Number", "CamNum"="Unit.Number","SD_card_num"="SD.Card.Number"  ))
```
Great!
### Step 3. Sort out ids
Now that we have all the data, we need to reduce the data set to the single species identification for each event.

For any event with a species receiving a proportion of the vote of 4 or 5 of 5 votes (proportion = 0.8 or higher), we will go with the most frequently assigned classification.

First, let's get just those events with propvote >= 0.8

```{r}
DF80<-filter(DF, propvote >=0.8)
```
And now reduce that data set to just the single highest choice for each subject_id:
```{r}
Choices80<-DF80 %>% group_by(subject_ids) %>% slice(which.max(propvote))
```
This dataset is ready for further analysis.

For the remaining events, we will need to look at the images and make a final determination.

```{r}
DF60<-filter(DF, propvote < 0.8)
```
Now we'd like to be able to get a summary data set that includes the subject id and then spreads the choices across rows.  We'll dump a bunch of unneeded rows as well.

```{r}
DF60<-DF60 %>% select(subject_ids, num_class, diff_species, choice, propvote, classification_id,Imj1, Imj2, Img3, ForestName)
```


Now loop through to list the choices


```{r}
numSubjects<-n_distinct(DF60$subject_ids)
subj_ids<-unique(DF60$subject_ids)
species<-character()
for (i in 1:numSubjects){
  set<-DF60 %>% filter(subject_ids == subj_ids[i])
  species[i]<-paste(set$choice, collapse = ", ")
}
#now bind species and subject_ids to then join to main DF
data<-as.data.frame(cbind(subj_ids, species), stringsAsFactors = F)
data$subj_ids<-as.integer(data$subj_ids)
```
Now subset the DF60 to the top choice and then join the choices we just made.

```{r}
Choices60<-DF60 %>% group_by(subject_ids) %>% slice(which.max(propvote))

Choices60<-left_join(Choices60, data, by = c("subject_ids" = "subj_ids"))
```
Now save for further use in looking at images

```{r}
write.csv(Choices60, "Data/need_evaluation.csv")
```
Once those choices are reconciled, we can bring back this data set and join it to Choices80 for further analysis.







